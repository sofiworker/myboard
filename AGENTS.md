## 项目概述

本项目是基于 Android Jetpack 组件和 Kotlin 语言构建的现代化输入法应用。采用现代 Android 开发最佳实践，包括响应式架构、声明式 UI 设计和模块化结构，旨在提供一个功能丰富、高度可定制且性能优异的输入解决方案。

你主要参考的项目 https://github.com/florisboard/florisboard

要求布局等大部分 UI 设置都可以自定义，比如：长按符号的弹出、工具栏、26键大小写展示等等

参考 florisboard 中的实现

- 布局为配置文件
- 配置信息能映射

你首先根据 florisboard 思考如何布局、配置如何开发及编写，并给出详细的阐述，如何这么设计，然后添加到该文档中用于架构设计指导

## 架构设计

键盘布局和配置的核心是能够灵活地定义和修改键盘的外观和行为。受到 FlorisBoard 的启发，我们采用基于 JSON 的配置文件系统来定义键盘布局。这种方法具有以下优点：

*   **可读性和可编辑性**：JSON 是一种人类可读的格式，可以轻松地手动编辑或通过工具生成。
*   **灵活性和可扩展性**：可以轻松添加新的键类型、动作和属性，而无需修改核心代码。
*   **动态加载**：键盘布局可以在运行时从 `assets` 目录动态加载，从而可以轻松地在不同布局之间切换或更新布局而无需重新编译应用程序。

### 数据模型

为了将 JSON 配置映射到应用程序中的对象，我们定义了以下可序列化的 Kotlin 数据类：

*   `KeyboardData`：表示一个完整的键盘布局，包括一个行列表和一个可选的工具栏。
*   `KeyData`：表示键盘上的单个键，包括其类型、标签、动作、权重和可选的附加键（用于长按弹出窗口）。
*   `KeyType`：一个枚举，用于定义键的类型（例如，`CHARACTER`、`MODIFIER`、`ACTION`）。
*   `KeyAction`：一个密封类，用于表示与按键按下相关的动作（例如，`InsertText`、`Delete`、`SwitchToLayout`）。

这些数据类使用 `kotlinx.serialization` 库进行序列化和反序列化，从而可以轻松地在 JSON 字符串和 Kotlin 对象之间进行转换。

### 布局加载

`KeyboardRepository` 类负责从 `assets` 目录加载和解析键盘布局。它使用 `AssetManager` 读取 JSON 文件，并使用 `kotlinx.serialization.json.Json` 实例将 JSON 字符串解码为 `KeyboardData` 对象。

### UI 渲染

`KeyboardScreen` Composable 负责渲染键盘 UI。它使用 `KeyboardViewModel` 获取当前的 `KeyboardData`，然后使用 `Column` 和 `Row` Composable 迭代行和键以构建键盘网格。每个键都由一个 `Key` Composable 表示，它处理自己的 UI（例如，标签、背景）和用户交互（例如，点击、长按）。

这种分层的方法允许 UI 和数据之间有清晰的分离，从而可以轻松地独立修改键盘的布局和外观。

## 技术选型

### 核心框架
- **Kotlin** - 主要开发语言
- **AndroidX** - Android Jetpack 核心组件库
- **Jetpack Compose** - 声明式 UI 框架
- **Material 3** - 现代化设计系统

### 架构模式
- **MVI/MVVM** - 状态管理架构模式
- **Repository 模式** - 数据层抽象设计
- **响应式编程** - Kotlin Flow 与 Coroutines

## 功能模块架构

### 1. 输入引擎核心模块
**职责**：处理所有输入逻辑、词库管理和算法处理
- 输入处理与转换
- 模糊音算法实现
- 智能排序与预测
- 词库管理与更新

### 2. UI/键盘界面模块
**职责**：键盘布局、交互和视觉效果
- 多种键盘布局（QWERTY、T9等）
- 主题与皮肤系统
- 单手模式支持
- 悬浮键盘实现
- 布局自定义编辑器

### 3. 系统集成模块
**职责**：与 Android 系统和其他应用的交互
- 剪切板管理
- 光标移动控制
- 字体系统集成
- 语音输入接口

### 4. 符号与内容模块
**职责**：特殊符号和表情内容管理
- 颜文字库
- 表情符号
- 数学符号
- 特殊符号集合

### 5. 设置与管理模块
**职责**：应用配置和用户偏好管理
- 统一设置管理
- 主题定制
- 键盘尺寸调整
- 横屏适配配置
- 布局在设置页面能可视化编辑

## 核心功能实现要点

### 主题与皮肤定制
- 支持动态主题切换
- 自定义颜色方案
- 背景图片支持
- 实时预览功能

### 模糊音输入
- 可配置的模糊音规则
- 实时匹配算法
- 用户习惯学习
- 方言适配支持

### 智能排序
- 基于使用频率的排序
- 上下文关联预测
- 个性化学习模型
- 多维度评分系统

### 剪切板管理
- 历史记录存储
- 智能分类整理
- 快速访问面板
- 安全隐私保护

### 光标移动管理
- 手势控制支持
- 精确定位算法
- 多光标支持
- 选择范围调整

### 多种输入布局
- QWERTY 全键盘
- T9 传统布局
- 单手优化布局
- 自定义布局创建

### 布局自定义
- 可视化布局编辑器
- 按键大小调整
- 功能键自定义
- 布局导入导出

### 颜文字与表情
- 分类表情库
- 颜文字集合
- 最近使用记录
- 快速搜索功能

### 单手键盘
- 左右手模式切换
- 可调节偏移量
- 手势快捷操作
- 自适应屏幕尺寸

### 尺寸自定义
- 高度宽度独立调整
- 按键大小设置
- 边距和间距配置
- 比例保持选项

### 横屏悬浮键盘
- 位置自由拖动
- 透明度调节
- 尺寸动态调整
- 自动隐藏功能

### 数学与特殊符号
- 数学符号库
- 公式输入支持
- 单位符号集合
- 专业领域符号

### 字体设置
- 系统字体集成
- 自定义字体导入
- 字号大小调节
- 字体效果设置

### 设置统一管理
- 分类设置界面
- 搜索设置项
- 导入导出配置
- 云端同步支持

### 语音输入接口
- 标准语音识别接口
- 多引擎支持架构
- 实时语音反馈
- 离线语音支持

## 开发规范

### 代码规范
- 遵循 Kotlin 官方编码规范
- 使用 Ktlint 进行代码检查
- 重要函数必须包含 KDoc 注释
- 保持模块间低耦合

### 命名规范
- 类名使用 PascalCase
- 变量和函数使用 camelCase
- 资源文件使用 snake_case
- 常量使用 UPPER_SNAKE_CASE

### 架构原则
- 单一职责原则
- 开闭原则
- 依赖倒置原则
- 接口隔离原则

## 测试策略

### 单元测试
- 核心算法测试
- 业务逻辑测试
- 数据转换测试

### 集成测试
- 模块间交互测试
- 系统集成测试
- 性能基准测试

### UI 测试
- 界面交互测试
- 主题切换测试
- 布局适配测试

## 性能优化目标

### 启动时间
- 冷启动 < 500ms
- 热启动 < 200ms
- 服务初始化 < 100ms

### 内存使用
- 常驻内存 < 50MB
- 峰值内存 < 100MB
- 无内存泄漏

### 响应速度
- 按键响应 < 16ms
- 主题切换 < 100ms
- 布局切换 < 200ms

## 安全与隐私

### 数据安全
- 本地数据加密存储
- 剪切板内容保护
- 用户习惯数据匿名化

### 权限管理
- 最小权限原则
- 运行时权限请求
- 权限使用说明

### 隐私保护
- 不收集敏感信息
- 用户数据本地处理
- 透明数据使用政策

## 兼容性要求

### 设备类型
- 手机全面适配
- 平板优化支持
- 折叠屏设备适配

### 系统特性
- 深色模式支持
- 多语言适配
- 无障碍功能

## 维护与扩展

### 代码维护
- 定期依赖更新
- 技术债务管理
- 性能监控优化

### 功能扩展
- 插件化架构设计
- 主题市场支持
- 词库在线更新

### 文档维护
- API 文档完整
- 用户指南更新
- 开发文档同步

## 开发环境要求

### 构建工具
- Gradle 8.0+
- Kotlin DSL 配置

## 执行计划

### 第一阶段：项目基础架构与核心功能 (已完成)
- **任务 1.1:** 实现基础 `InputMethodService` 并显示一个简单的键盘
- **任务 1.2:** 定义键盘布局和按键的核心数据模型及配置文件
- **任务 1.3:** 实现基础 MVI/MVVM 架构用于状态管理
- **任务 1.4:** 使用 Jetpack Compose 创建一个写死的键盘布局

### 第二阶段：输入引擎与词库功能 (已完成)
- **任务 2.1:** 设计并实现输入处理逻辑 (字符映射, 按键事件)
- **任务 2.2:** 开发词库管理系统 (加载, 查询)
- **任务 2.3:** 实现基础的建议算法 (例如, 基于频率)
- **任务 2.4:** 实现模糊拼音/拼写逻辑
- **任务 2.5:** 将输入引擎与UI集成以显示建议
- **任务 2.6:** 实现基本的词语组合和候选词选择

### 第三阶段：UI定制与高级功能 (已完成)
- **任务 3.1:** 开发主题和皮肤系统 (颜色, 背景)
- **任务 3.2:** 实现长按弹出符号功能
- **任务 3.3:** 创建键盘工具栏并允许自定义按钮
- **任务 3.4:** 实现切换不同键盘布局的逻辑 (例如, QWERTY, 符号)
- **任务 3.5:** 开发大小写切换逻辑
- **任务 3.6:** 构建用于基本UI定制的设置屏幕 (例如, 键盘高度)
- **任务 3.7:** 开始可视化布局编辑器的工作

### 第四阶段：系统集成与扩展功能 (进行中)
- **任务 4.1:** 实现剪贴板管理功能 (历史记录, 置顶)
- **任务 4.2:** 通过手势或专用键开发光标控制功能
- **任务 4.3:** 实现表情/颜文字键盘视图和库
- **任务 4.4:** 实现单手模式
- **任务 4.5:** 实现悬浮键盘模式
- **任务 4.6:** 创建语音输入接口
